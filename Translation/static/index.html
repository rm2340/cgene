<!DOCTYPE HTML>

<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Translation</title>

    <script type="text/javascript" src="static/jquery-3.2.1.js"></script>
    <script type="text/javascript" src="static/highcharts.js"></script>
    <script type="text/javascript" src="static/fraction.js"></script>
    <link rel="stylesheet" type="text/css" href="static/index.css">
</head>

<body>

    <div id="graph"></div>

    <div id="interface">
        <table>
            <tr>
                <td>Ribosomes</td>
                <td>
                    <form id="ribosomes.form">
                        <input type="text" size="6" id="ribosomes.quant" value="">
                        <input type="button" id="ribosomes.button" value="Set">
                    </form>
                </td>
            </tr>
            <tr>
                <td>mRNAs</td>
                <td><span id="mrnas.info">--</span></td>
            </tr>
            <tr>
                <td>Proteins</td>
                <td><span id="proteins.info">--</span></td>
            </tr>
            <tr>
                <td>mRNA Degradation</td>
                <td>
                    <form>
                        <input type="radio" name="degMrna" id="degMrna.off" value="off" checked> Off
                        <input type="radio" name="degMrna" id="degMrna.on" value="on"> On; &ensp;Rate
                        <input type="text" size="6" id="degMrna.rate" value="">
                        <input type="button" id="degMrna.button" value="Set">
                    </form>
                </td>
            </tr>
            <tr>
                <td>Protein Degradation</td>
                <td>
                    <form>
                        <input type="radio" name="degProt" id="degProt.off" value="off" checked> Off
                        <input type="radio" name="degProt" id="degProt.on" value="on"> On; &ensp;Rate
                        <input type="text" size="6" id="degProt.rate" value="">
                        <input type="button" id="degProt.button" value="Set">
                    </form>
                </td>
            </tr>
            <tr>
                <td>Transcription Rates</td>
                <td></td>
            </tr>
            <tr>
                <td>
                    <form id="info">
                        <input type="button" id="updateInfo.button" value="Update Info">
                    </form>
                </td>
            </tr>
        </table>
    </div>



    <script>
        var chart; // global

        // Fetch JSON and populate graphs
        function loadJSON() {
            // https://lostechies.com/joshuaflanagan/2011/10/20/coordinating-multiple-ajax-requests-with-jquery-when/
            $.when(
                $.getJSON("call/Model/getTSumMrna"),
                $.getJSON("call/Model/getTSumProtein"),
                $.getJSON("call/Model/getTSumRibosome")
            ).done(function(dataM, dataP, dataR) {
                // TODO: check for success before stumbling ahead?

                var series = chart.series[0],
                    shift = series.data.length > 1000; // shift if the series is longer than ..

                var plotData = [{
                        x: dataM[0].result.fst.timeValue,
                        y: dataM[0].result.snd,
                    },
                    {
                        x: dataP[0].result.fst.timeValue,
                        y: dataP[0].result.snd,
                    }
                ];

                chart.series[0].addPoint(plotData[0], true, shift);
                chart.series[1].addPoint(plotData[1], true, shift);

                // call it again after .. miliseconds
                setTimeout(loadJSON, 1000);

            });
        }

        function buildChart() {
            chart = new Highcharts.Chart('graph', {
                chart: {
                    renderTo: 'graph',
                    defaultSeriesType: 'line',
                    events: {
                        load: loadJSON
                    }
                },
                title: {
                    text: 'Live Cell Data'
                },
                xAxis: {
                    //type: 'datetime',
                    //tickPixelInterval: 150,
                    //maxZoom: 20 * 1000
                },
                yAxis: {
                    //minPadding: 0.2,
                    //maxPadding: 0.2,
                    title: {
                        text: 'Quantity',
                        //margin: 80
                    }
                },
                series: [{
                        name: "mRNA",
                        data: []
                    },
                    {
                        name: "Protein",
                        data: []
                    }
                ]
            });
        }



        $(document).ready(function() {
            buildChart();
            modelInfo();
        });

        document.getElementById("updateInfo.button").addEventListener("click", modelInfo);
        document.getElementById("ribosomes.button").addEventListener("click", setRibosomes);
        document.getElementById('degMrna.on').addEventListener("click", setMrnaDeg);
        document.getElementById('degMrna.off').addEventListener("click", setMrnaDeg);
        document.getElementById('degMrna.button').addEventListener("click", setMrnaDeg);
        document.getElementById('degProt.on').addEventListener("click", setProtDeg);
        document.getElementById('degProt.off').addEventListener("click", setProtDeg);
        document.getElementById('degProt.button').addEventListener("click", setProtDeg);

        document.getElementById("ribosomes.quant").addEventListener("keyup", function(event) {
            //event.preventDefault();
            if (event.keyCode == 13) {
                setRibosomes;
            }
        });

        function modelInfo() {
            $.when(
                $.getJSON("call/Model/getInfoMrna"),
                $.getJSON("call/Model/getSumProtein"),
                $.getJSON("call/Model/getQuantRibosome"),
                $.getJSON("call/Model/statusDegradationMrna"),
                $.getJSON("call/Model/statusDegradationProtein"),
//                $.getJSON("call/Model/statusTranscription"),

            ).done(function(dataM, dataP, dataR, degM, degP) {
                // TODO: check for success before stumbling ahead?
                document.getElementById("mrnas.info").innerHTML = dataM[0].result;
                document.getElementById("proteins.info").innerHTML = dataP[0].result;
                document.getElementById("ribosomes.quant").value = dataR[0].result;

                document.getElementById('degMrna.on').checked = degM[0].result.fst;
                document.getElementById('degMrna.off').checked = !degM[0].result.fst;
                document.getElementById("degMrna.rate").value = degM[0].result.snd;

                document.getElementById('degProt.on').checked = degP[0].result.fst;
                document.getElementById('degProt.off').checked = !degP[0].result.fst;
                document.getElementById("degProt.rate").value = degP[0].result.snd;
                
//                console.log(trans);
            });
        }

        function setRibosomes() {
            var v = document.getElementById("ribosomes.quant").value;
            $.get("call/Model/setQuantRibosomes?n=" + v);
        }

        function setMrnaDeg() {
            rate = document.getElementById('degMrna.rate').value;
            rat = new Fraction(rate);
            on = document.getElementById('degMrna.on').checked;
            $.get("call/Model/setDegradationMrna?on=" + on + "&nom=" + rat.n + "&den=" + rat.d);
        }

        function setProtDeg() {
            rate = document.getElementById('degProt.rate').value;
            rat = new Fraction(rate);
            on = document.getElementById('degProt.on').checked;
            $.get("call/Model/setDegradationProt?on=" + on + "&nom=" + rat.n + "&den=" + rat.d);
        }

        function createTable(tableData) {
            var table = document.createElement('table');
            var tableBody = document.createElement('tbody');

            tableData.forEach(function(rowData) {
                var row = document.createElement('tr');

                rowData.forEach(function(cellData) {
                    var cell = document.createElement('td');
                    cell.appendChild(document.createTextNode(cellData));
                    row.appendChild(cell);
                });

                tableBody.appendChild(row);
            });

            table.appendChild(tableBody);
            document.body.appendChild(table);
        }

    </script>




</body>

</html>
